{% extends "base.html" %}
{% block content %}
<div class="container-fluid px-4 pb-5">
    <div class="row">
        <div class="col-12 col-md-4 mb-4 border-end border-secondary-subtle">
            <h2 class="fw-bold text-uppercase mb-0">{{ char.nome }}</h2>
            <p class="text-muted small mb-4">{{ char.dados.arquetipo }} | NÍVEL: {{ char.dados.nivel or 1 }}</p>
            
            <div class="bg-white p-3 rounded-3 shadow-sm mb-4">
                <div class="mb-2">
                    <label class="small fw-bold">PV</label>
                    <input type="number" class="form-control-sm border-0 bg-light w-25" value="{{ char.dados.status.pv_atual }}"> / {{ char.dados.status.pv_max }}
                </div>
                <div class="mb-2">
                    <label class="small fw-bold">PF</label>
                    <input type="number" class="form-control-sm border-0 bg-light w-25" value="{{ char.dados.status.fluxo_atual }}"> / {{ char.dados.status.fluxo_max }}
                </div>
                <div>
                    <label class="small fw-bold">PP</label>
                    <input type="number" class="form-control-sm border-0 bg-light w-25" value="{{ char.dados.status.paradoxo }}">
                </div>
            </div>

            <h6 class="fw-bold border-bottom pb-2">ATRIBUTOS & PERÍCIAS</h6>
            <div class="pericias-container overflow-auto" style="max-height: 50vh;">
                {% for atrib, valor in char.dados.atributos.items() %}
                    <div class="p-2 mb-1 bg-dark text-white rounded cursor-pointer" 
                         onclick="prepararRolagem('{{ atrib|upper }}', {{ valor }})">
                        <strong>{{ atrib|upper }}</strong> <span class="float-end">{{ valor }}</span>
                    </div>
                    {% for p, v in char.dados.pericias.items() %}
                        {# Aqui você pode filtrar quais perícias pertencem a qual atributo se desejar #}
                        <div class="ps-3 py-1 border-bottom small d-flex justify-content-between cursor-pointer hover-bg"
                             onclick="prepararRolagem('{{ p|upper }} ({{ atrib|upper }})', {{ v|int + valor|int }})">
                            <span>{{ p|upper }}</span>
                            <span class="fw-bold">{{ v }}</span>
                        </div>
                    {% endfor %}
                {% endfor %}
            </div>
        </div>

        <div class="col-12 col-md-4 mb-4 border-end border-secondary-subtle">
            <h6 class="fw-bold border-bottom pb-2 text-uppercase">Habilidades</h6>
            <textarea class="form-control border-0 bg-white mb-4" rows="12" style="resize: none;">{{ char.dados.habilidades }}</textarea>
            
            <h6 class="fw-bold border-bottom pb-2 text-uppercase">Inventário</h6>
            <textarea class="form-control border-0 bg-white" rows="8" style="resize: none;">{{ char.dados.itens|join(', ') }}</textarea>
        </div>

        <div class="col-12 col-md-4">
            <h6 class="fw-bold border-bottom pb-2 text-uppercase">Log de Rolagens</h6>
            <div id="chat-box" class="bg-black text-success p-3 rounded-3 mb-2 shadow-inset" 
                 style="height: 500px; overflow-y: auto; font-family: 'Courier New', Courier, monospace; font-size: 0.9rem;">
                <div>> Sistema pronto. Clique em uma perícia para rolar.</div>
            </div>
            <div class="input-group">
                <span class="input-group-text bg-dark border-0 text-white">></span>
                <input type="text" id="chat-input" class="form-control bg-dark text-white border-0" placeholder="Comando de texto...">
            </div>
            
            <div class="d-grid gap-2 mt-4">
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-dark btn-sm">VOLTAR</a>
            </div>
        </div>
    </div>
</div>

<style>
    .cursor-pointer { cursor: pointer; }
    .hover-bg:hover { background-color: rgba(0,0,0,0.05); }
    .shadow-inset { box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); }
</style>

<script>
function prepararRolagem(nome, qtdDados) {
    if (qtdDados < 1) qtdDados = 1; // Mínimo de 1 dado
    
    let resultados = [];
    for (let i = 0; i < qtdDados; i++) {
        resultados.push(Math.floor(Math.random() * 6) + 1);
    }
    
    const chatBox = document.getElementById('chat-box');
    const rolagemDiv = document.createElement('div');
    rolagemDiv.className = 'mb-2 border-start border-success ps-2';
    
    let data = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    rolagemDiv.innerHTML = `
        <small class="text-muted">[${data}]</small> <br>
        <span class="text-white fw-bold">${nome}</span>: ${qtdDados}d6<br>
        <span class="text-warning">${resultados.map(r => `[${r}]`).join(' ')}</span>
    `;
    
    chatBox.appendChild(rolagemDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
}
</script>
{% endblock %}